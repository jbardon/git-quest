
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Rewrite history · Git Quest</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Jérémy Bardon">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-asciidoc-admonition-icons/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../asciidoctor.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="team-work.html" />
    
    
    <link rel="prev" href="resolve-conflicts.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../TODO.html">
            
                <a href="../TODO.html">
            
                    
                    Todo
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Articles</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="intro.html">
            
                <a href="intro.html">
            
                    
                    Why do you need Git?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="simple-workflow.html">
            
                <a href="simple-workflow.html">
            
                    
                    Two beginner workflows
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="explore-project.html">
            
                <a href="explore-project.html">
            
                    
                    Explore your repository
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="resolve-conflicts.html">
            
                <a href="resolve-conflicts.html">
            
                    
                    Resolve conflicts
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.5" data-path="rewrite-history.html">
            
                <a href="rewrite-history.html">
            
                    
                    Rewrite history
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="team-work.html">
            
                <a href="team-work.html">
            
                    
                    Team work
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Quests</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../quests/quest1/quest1.main.html">
            
                <a href="../quests/quest1/quest1.main.html">
            
                    
                    Add, commit and push
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../quests/quest2/quest2.main.html">
            
                <a href="../quests/quest2/quest2.main.html">
            
                    
                    Play with staging area
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../quests/quest3/quest3.main.html">
            
                <a href="../quests/quest3/quest3.main.html">
            
                    
                    Search the mysterious message
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Help</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../others/quests-help.html">
            
                <a href="../others/quests-help.html">
            
                    
                    Get help for your Quest
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../quests/quest1/quest1.help.html">
            
                <a href="../quests/quest1/quest1.help.html">
            
                    
                    Help
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../quests/quest2/quest2.help.html">
            
                <a href="../quests/quest2/quest2.help.html">
            
                    
                    Help
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="../quests/quest3/quest3.help.html">
            
                <a href="../quests/quest3/quest3.help.html">
            
                    
                    Help
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Rewrite history</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
                                <section class="normal markdown-section">
                                
                                <h1 id="rewrite-history">Rewrite history</h1>
<div id="preamble">
<div class="sectionbody">
<div class="literalblock">
<div class="content">
<pre>- fait n&apos;importe quoi -&gt; distant --hard</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Add files in the previous commit</p>
</li>
<li>
<p>Change the previous commit (reset)</p>
</li>
<li>
<p>Change one far away commit (fixup)</p>
</li>
<li>
<p>Group commits in a single one</p>
</li>
<li>
<p>Changes multiple commits (reword, edit, drop)</p>
</li>
<li>
<p>Reset a file to its original state</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You just commit your work and eventually push it to server.
The problem is your commit is wrong, you want to change the message, its content, cancel it or even group multiple commits in a single one.</p>
</div>
<div class="paragraph">
<p>All those operations can be done with <code>git rebase</code>.
This is the multi-tool to rewrite your history.
Before going further, I should warn you&#xA0;: changing the history is handy but you most follow some rules to avoid puting the mess in your repository.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_files_in_the_previous_commit">Add files in the previous&#xA0;commit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#x2019;s take a first example to explain what happens when the history changes.
The simpler situation is when you made a commit (only locally) but forgot to add a file and don&#x2019;t want to create a fix commit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git add forgotten-file.txt
$ git commit --amend --no-edit</pre>
</div>
</div>
<div class="paragraph">
<p>Just add your files in the staging area as you want to create a new commit.
The only difference is the <code>--amend</code> options which tells git to include the stagged changes in the previous commit.
While <code>--no-edit</code> only specify you don&#x2019;t want to update the commit message.
It means you can change the previous commit message with nothing more than <code>git commit --amend</code>.</p>
</div>
<div class="paragraph">
<p>Now, you&#x2019;ll rewrite the last commit again but check the commit SHA1 before and after the amend commit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git log --pretty=oneline -1 # Show the last commit on one line
$ git commit --amend --no-edit
$ git log --pretty=oneline -1</pre>
</div>
</div>
<div class="paragraph">
<p>Did you notice your commit SHA1 changed?
It&#x2019;s different because the commit isn&#x2019;t the same as before: the content and date aren&#x2019;t the same.
Think about what happens if you replaced a pushed commit?
You can do whatever you want on your local repository but once you want to push, you&#x2019;ll get troubles.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="todo.jpg" alt="sch&#xE9;ma commit A et A&apos;"></span></p>
</div>
<div class="paragraph">
<p>There are two different commits with the same parent commit.
Yet, git don&#x2019;t know what do to with this.
I&#x2019;ll explain you how to deal with this situation after presenting the most useful history rewriting commands.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_change_the_previous_commit">Change the previous&#xA0;commit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you want to completely change your last commit, such as modifying a committed file or remove one.
For some cases using an amend commit isn&#x2019;t enough because you need to visualize all changes in the previous commit.</p>
</div>
<div class="paragraph">
<p>Here comes the <code>reset</code> command which helps to move changes between the repository, the staging area and the working directory.
Our purpose is to move before the last commit but keep the changes in the working directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git reset --soft
$ git reset --mixed
$ git reset --hard</pre>
</div>
</div>
<div class="paragraph">
<p>There are three flavours of <code>reset</code>.
In this snippet, they comes from the less impacting to the more impacting in your project.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="todo.jpg" alt="une image"></span></p>
</div>
<div class="paragraph">
<p>Soft only moves to the previous commit but keep all changes in your working directory and also already staged.
Mixed which is also the default behavior resets to the previous commit, put nothing in the staging area but keep the modifications in the working directory.
The last one is critical because it goes back to the specified commit and erase all modifications in you current directory.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Don&#x2019;t use reset --&#x200A;hard unless you know what you&#x2019;re&#xA0;doing</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>In this rewrite history scenario, we want to undo the last commit but keep the changes in the working directory. You&#x2019;ll use <code>git reset HEAD~1</code>.
Head is the shortcut to current commit, so reset to before the last commit.</p>
</div>
<div class="paragraph">
<p>With this command you still have all modifications from the commit in your working directory but it&#x2019;s like you&#x2019;re before committing.
If you want to reset the changes for one file use <code>git checkout&#x2009;&#x2014;&#x2009;file.txt</code>.
This is the special use case for checkout with a file as parameter, the <code>--</code> specifies it isn&#x2019;t a commit.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_change_an_older_commit">Change an older&#xA0;commit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>From now, you&#x2019;re able to change the last commit in the history.
What if you want to change the commit before the last one?</p>
</div>
<div class="paragraph">
<p>It&#x2019;s possible by replacing <code>amend</code> with <code>fixup</code> and giving the commit SHA1 you want to modify.
This fixup commit is now the  last commit.
You have to use rebase with a specific options to ask git to rewrite the history and merge fixup commits with their target commit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git commit --fixup TARGET_COMMIT
$ git rebase TARGET_COMMIT~ --autosquash</pre>
</div>
</div>
<div class="paragraph">
<p>The rebase command is the multi-tool command for rewriting history.
In this example the <code>autosquash</code> option warn git there are fixup commits to merge (or squash) with their target commit.
The first parameter set from which commit history rewriting should begin.
<code>TARGET~</code> means before the  target commit.
You can also specify a number such as <code>commit~4</code> to begin 4 commits before.
Usually, you&#x2019;ll replace <code>TARGET</code> with <code>HEAD</code> which an alias for the current last commit.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_group_commits_into_a_single_one">Group commits into a single&#xA0;one</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The last example explained how to squash a fixup commit with a commit.
Yet, it&#x2019;s also possible to squash any commit and any number successive commits.</p>
</div>
<div class="paragraph">
<p>For sure this job is for the rebase command.
This time you&#x2019;ll run it in interactive mode to tweak the history as you want.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git rebase commit~4 -i</pre>
</div>
</div>
<div class="paragraph">
<p>In interactive mode, you have the list of commits to rebase.
You have to choose what to do with each commit.
The default option is <strong>pick</strong> which means pick this commit and put it in the new history.
If every commit action pick, your history will not change.
From this, you can specify a particular action in the available list for each commit.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="todo.jpg" alt="Capture du rebase mode"></span></p>
</div>
<div class="paragraph">
<p>The action we&#x2019;re interesting in, for this scenario is squash.
When a commit must be squashed, git pick changes from this commit and put them in the next commit.
Then it drops the squash commit.
You can squash any number of successive commit, but you can&#x2019;t squash the most recent commit.
Indeed, this is the last commit so there is no next commit to squash with.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_edit_multiple_commits">Edit multiple commits</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Did you look at the actions rebase offers in interactive mode?
It provides a wide range of actions from the simple reword (update commit message) to the full of promise edit action.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="todo.png" alt="une capture de toutes les options"></span></p>
</div>
<div class="paragraph">
<p>Most of the actions are not hard to understand.
You already what <code>pick</code>, <code>reword</code>, <code>squash</code> and also guessed what <code>drop</code> can do to your commit.
In the real world you&#x2019;ll not use rebase a lot except to clean your history with <code>squash</code> or <code>reword</code> a bad commit message.</p>
</div>
<div class="paragraph">
<p>As you may notice, <code>edit</code> description is quite explicit.
It stops on the commit and let you the possibility to do changes and run a <code>amend</code> as we saw before.</p>
</div>
<div class="paragraph">
<p>When you choose actions which require manual changes such as edit, the rebase command take a break.
Once you finished your changes, you can resume the rebase with <code>git rebase --continue</code> as the <code>git status</code> suggests.
Also, you may did something wrong during the rebase.
You can exit the rebase and recover the state before the rebase with <code>git rebase --abort</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_can_t_push_my_new_history">Can&#x2019;t push my new&#xA0;history</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rebasing the history means replace an old commit with a new one.
Even if you don&#x2019;t change its content and you choose the pick action, the commit SHA1 will change.</p>
</div>
<div class="paragraph">
<p>Now you want to push your changes to the server.
But it asks you to pull before because the local history isn&#x2019;t up to date.
You&#x2019;ll for sure get trouble with this.
Because of the rebase, you end up with a different history.
There are two times the same commits but with a different SHA1.
It&#x2019;s enough for git to say they aren&#x2019;t the same.
It asks you to merge the local and remote commits.</p>
</div>
<div class="paragraph">
<p>Yet, merging two commits which does the same thing is a non-sense.
When you do rebase your version is right and you need to tell to it to git with a <code>git push --force</code> instead of pull.</p>
</div>
<div class="paragraph">
<p>This is were you can loose your work or your colleagues one.
Push with the force means take the local history and put it on the remote.
As soon as you didn&#x2019;t pull before, if your colleagues pushed in the meantime, their commits will be lost.
And they will get trouble to synchronise their local history with the brand new remote.
If you have to use force prefer <code>--force-with-lease</code> which fails if a new commit was pushed to the server.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Only push --force not shared branch. Otherwise, at least be polite and prefer to --force-with-lease</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>To make it short, don&#x2019;t rebase a shared branch, it&#x2019;s dangerous.
Yet, you can rebase your own branch as you wish (learn about branches later).</p>
</div>
<div class="paragraph">
<p>If you already <code>push --force</code>, this is possible to repair your mistake.
Either a colleague of yours <code>push --force</code> their local history and delete your work.
Or all your colleagues must merge their local with the remote.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git fetch --all
$ git reset --hard origin/master</pre>
</div>
</div>
<div class="paragraph">
<p>With this second way, your work is safe but any modifications your colleagues didn&#x2019;t pushed will be dropped because of the <code>reset --hard</code>.
This is possible to keep them but it involves either stash or branch from master and cherry-pick.</p>
</div>
<div class="paragraph">
<p>Any way, you understand it&#x2019;s bad to force push a shared branch.
Prefer the first solution and use a branch and cherry-pick to get back your changes.
No details about how to do it exactly because you shouldn&#x2019;t be in this kind of situation and it depends on how big your changes are.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_drop_a_commit_without_rebase">Drop a commit without&#xA0;rebase</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The last situation is when you pushed something but you want to delete the commit.
It happens if the feature isn&#x2019;t ready or if your commit breaks too many thing and you need time to fix it.</p>
</div>
<div class="paragraph">
<p>You already know how to drop a commit with rebase but there is another way without rewriting the history.
This is what revert is made for.
It gets any commit a build a commit with the exact inverse from the target commit.
This creates a new commit and keep your buggy commit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git revert COMMIT</pre>
</div>
</div>
<div class="paragraph">
<p>By the way git is asking a message for this revert commit and automatically includes the target commit SHA1 in the message.
Later, you can use <code>cherry-pick</code> your buggy commit to get your changes back, fix it and <code>amend</code> it.</p>
</div>
<div class="paragraph">
<p>If you need to revert more than one commit you must be careful about the order.
Revert the most recent commit first and go down to the older.
The order isn&#x2019;t enough because you&#x2019;ll get an history with 3 revert commit if you reverted 3 commit and this is too much.</p>
</div>
<div class="paragraph">
<p>For this situation, I&#x2019;ld recommend to confirm the first revert commit and then <code>amend</code> this first revert commit.
Be careful to include all reverted commits SHA1 in the commit message to keep a clear history.
This was one solution.
You can also create the 3 revert commits and then use rebase to squash them into one single commit afterward.</p>
</div>
</div>
</div>
                                
                                </section>
                            
                        </div>
                    </div>
                
            </div>

            
                
                <a href="resolve-conflicts.html" class="navigation navigation-prev " aria-label="Previous page: Resolve conflicts">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="team-work.html" class="navigation navigation-next " aria-label="Next page: Team work">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Rewrite history","level":"2.5","depth":1,"next":{"title":"Team work","level":"2.6","depth":1,"path":"articles/team-work.adoc","ref":"articles/team-work.adoc","articles":[]},"previous":{"title":"Resolve conflicts","level":"2.4","depth":1,"path":"articles/resolve-conflicts.adoc","ref":"articles/resolve-conflicts.adoc","articles":[]},"dir":"ltr"},"config":{"plugins":["asciidoc-admonition-icons","asciidoc-include@0.1.8","back-to-top-button","collapsible-chapters","edit-link","github","-fontsettings","-sharing"],"root":"src","styles":{"website":"asciidoctor.css"},"pluginsConfig":{"asciidoc-include":{"syntax":"asciidoc"},"github":{"url":"https://github.com/your/repo"},"asciidoc-admonition-icons":{},"search":{"maxIndexSize":1000000},"collapsible-chapters":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"highlight":{},"back-to-top-button":{},"edit-link":{"label":"Edit This Page","base":"https://github.com/USER/REPO/tree/BRANCH/path/to/book"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Jérémy Bardon","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Git Quest","gitbook":"*"},"file":{"path":"articles/rewrite-history.adoc","mtime":"2019-01-19T09:14:31.620Z","type":"asciidoc"},"gitbook":{"version":"3.2.3","time":"2019-01-29T19:57:05.064Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    

    </body>
</html>

